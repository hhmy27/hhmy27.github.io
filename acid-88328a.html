<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- iOS Safari -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- Chrome, Firefox OS and Opera Status Bar Color -->
<meta name="theme-color" content="#FFFFFF">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
<link rel="stylesheet" type="text/css"
  href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
<link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
<link rel="stylesheet" type="text/css" href="css/theme.css">
<link rel="stylesheet" type="text/css" href="css/notablog.css">
<!-- Favicon -->

  <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;📖&lt;/text&gt;&lt;/svg&gt;">

<style>
  :root {
    font-size: 20px;
  }
</style>
  <title>ACID和实现原理&nbsp;|&nbsp;Notablog</title>
  <meta property="og:type" content="blog">
  <meta property="og:title" content="ACID和实现原理">
  
    <meta name="description" content="介绍数据库事务ACID的特性以及如何实现">
    <meta property="og:description" content="介绍数据库事务ACID的特性以及如何实现">
  
  
  <style>
    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
  <a href="index.html">
    <div class="Navbar__Btn">
      
        <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;📖&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
      
      <span>Home</span>
    </div>
  </a>
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="about.html">
        <div class="Navbar__Btn">
          
            <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;😀&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
          
          <span>关于我</span>
        </div>
      </a>
    
  
    
  
    
  
    
  
    
  
</nav>
  <header class="Header">
    
    <div class="Header__Spacer Header__Spacer--NoCover">
    </div>
    
    <h1 class="Header__Title">ACID和实现原理</h1>
    
      <div class="DateTagBar">
        
          <span class="DateTagBar__Item DateTagBar__Date">Posted on Thu, Nov 17, 2022</span>
        
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--red">
            <a href="tag/数据库.html">数据库</a>
          </span>
        
      </div>
    
  </header>
  <article id="https://www.notion.so/88328a5c5b894777b3dcf26270f78697" class="PageRoot"><ul id="https://www.notion.so/89077918aec445a89bec68b9c3b2b6b8" class="ColorfulBlock ColorfulBlock--ColorGray TableOfContents"><li class="TableOfContents__Item"><a href="#https://www.notion.so/71ee7729f9724eeda13d3d2e06b51380"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">简介</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/07c2736c41a64367b3309ffedbc39526"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">基础概念</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/1c4f3cb53138461586687a1306ab0fb5"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">原子性</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/fb0137d4c64c495cbbf4cf292e3a369a"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">实现原理 undo log</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/a2515967716349c7aebbd2c7ea3bf2be"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">持久性</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/b633ed2a3aae43138379a91811ee9d89"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">实现原理 redo log</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/5aa206ea9d404ff7afca9b319d1f990f"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">隔离性</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/55d6fe8d57dc4d30a91cba2f1665fccd"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">隔离不足出现的问题</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/380eee2d9e9b4a4ea71b28f16e33a7fe"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">事务隔离级别</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/cf997bf46ed041a5a460049f7e55cc06"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">RR隔离级别如何解决不可重复读和幻读</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/3394c2b821ce45c683a23613d97bd655"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">一致性</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/89ec1be975154ce282d3283ac4e065ff"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">如何实现一致性</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/8cf1696ecf2e40a98647acefd7a6c356"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">总结</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/27d4f2c0f11e4e9eb3a150b93362899f"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">Ref</span></span></div></a></li></ul><h1 id="https://www.notion.so/71ee7729f9724eeda13d3d2e06b51380" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/71ee7729f9724eeda13d3d2e06b51380"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">简介</span></span></h1><div id="https://www.notion.so/7fbb4de499f545dea372413935fb374c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">本文主要解释事务的ACID特性和相关实现原理，背景是Mysql5.6，数据引擎是Inno db</span></span></p></div><h1 id="https://www.notion.so/07c2736c41a64367b3309ffedbc39526" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/07c2736c41a64367b3309ffedbc39526"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">基础概念</span></span></h1><div id="https://www.notion.so/003a6bcc84be476f868d756fc5561da3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">事务是指一组操作，这组操作要么全都执行成功，要么全都不执行。</span></span></p></div><div id="https://www.notion.so/361d8986af634a85a136ebb40b9dd83e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">MySQL的架构</strong></span></span></p></div><div id="https://www.notion.so/f515b63beaf746e1b79637e5969d76f7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">首先我们了解一下MySQL的架构</span></span></p></div><div id="https://www.notion.so/3bc20f32681644ac9ed8a7ea35f0c9cc" class="Image Image--Normal"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F6ef19ad6-d28a-4a6e-9841-0833386af85d%2FUntitled.png?width=554&amp;table=block&amp;id=3bc20f32-6816-44ac-9ed8-a7ea35f0c9cc"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F6ef19ad6-d28a-4a6e-9841-0833386af85d%2FUntitled.png?width=554&amp;table=block&amp;id=3bc20f32-6816-44ac-9ed8-a7ea35f0c9cc" style="width:554px"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/670d7c6a5a8b49709024767245db19f2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">MySQL的结构一共可以分为三层</span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/cdf482ce4d3d4497b69a937383451052" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">链接层，处理链接，授权认证等</span></span></li><li id="https://www.notion.so/864c56deed4f46bc8066afcd048fed3b" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">服务器层，负责语句的解析、优化</span></span></li><li id="https://www.notion.so/0ea59a57ec5440799a44517c422b6bf7" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString">存储引擎层，其中使用最广泛的存储引起是InnoDB。MySQL本身是不支持事务的，事务是由存储引擎实现的。</span></span></li></ol><div id="https://www.notion.so/049ce2b9997c4bc1b684aa0750581386" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">事务的提交</strong></span></span></p></div><pre id="https://www.notion.so/c13e94edaae84438aa0c7b67ab44e03a" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">start</span> <span class="token keyword">transaction</span><span class="token punctuation">;</span> <span class="token comment"># 开启一个事务</span>
……  <span class="token comment">#一条或多条sql语句</span>
<span class="token keyword">commit</span><span class="token punctuation">;</span> <span class="token comment"># 提交</span></span></span></span></code></pre><div id="https://www.notion.so/2b6113ca659a424485b3e81c811bbf80" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Mysql中默认是autocommit（自动提交）模式，如果没有显示的开启一个事务，那么每个SQL语句都会当作一个事务执行。</span></span></p></div><div id="https://www.notion.so/d8ae8fc6767a4f7d93fd53cc3bb5c052" class="Image Image--Normal"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F973a0d0a-5de9-446e-822d-af04d7cee855%2FUntitled.png?width=298&amp;table=block&amp;id=d8ae8fc6-767a-4f7d-93fd-53cc3bb5c052"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F973a0d0a-5de9-446e-822d-af04d7cee855%2FUntitled.png?width=298&amp;table=block&amp;id=d8ae8fc6-767a-4f7d-93fd-53cc3bb5c052" style="width:298px"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/790257b4da4f405a886f2d8c94d61593" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">我们也可以通过</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code"> set autocommit = 0</code></span><span class="SemanticString">，关闭自动提交；需要注意的是，autocommit参数是针对连接的，在一个连接中修改了参数，不会对其他连接产生影响。</span></span></p></div><div id="https://www.notion.so/fea3e3fd7d8a4738888285c3f4c4c300" class="Image Image--Normal"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fdac21077-644b-4a99-9fab-29ef336a31ba%2FUntitled.png?width=289&amp;table=block&amp;id=fea3e3fd-7d8a-4738-8882-85c3f4c4c300"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fdac21077-644b-4a99-9fab-29ef336a31ba%2FUntitled.png?width=289&amp;table=block&amp;id=fea3e3fd-7d8a-4738-8882-85c3f4c4c300" style="width:289px"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/8aaf541abeaf49f9b608acb2edb4ee5d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">如果关闭了autocommit，则所有的sql语句都在一个事务中，直到执行了commit或rollback，该事务结束，同时开始了另外一个事务。</span></span></p></div><div id="https://www.notion.so/d706d7f2ba70481c9788d189ba8244d9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">强制提交的命令</strong></span></span></p></div><div id="https://www.notion.so/b214e8514ffb4cc0bd90e89a0dedc97a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">在MySQL中，存在一些特殊的命令，如果在事务中执行了这些命令，会马上强制执行commit提交事务；如DDL语句(create table/drop table/alter/table)、lock tables语句等等。</span></span></p></div><div id="https://www.notion.so/1a7450cc3ab749fea4c69d3dd0a1661d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">不过，常用的select、insert、update和delete命令，都不会强制提交事务。</span></span></p></div><div id="https://www.notion.so/ccf660224b7b4e5f91f341b4ad2e38f7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">ACID</strong></span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/1b2a8c42202d456fbd2e14ed2345b8d6" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">原子性 Atomicity</span></span></li><li id="https://www.notion.so/cd4432eaa2954b44a02e1ac42551e175" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">一致性 Consistency</span></span></li><li id="https://www.notion.so/cfdd2808992442898e54ae7de6bd7d80" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">隔离性 Isolation</span></span></li><li id="https://www.notion.so/789168c9b5004f50bcd38a1fa0886f8c" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">持久性 Durability</span></span></li></ul><h1 id="https://www.notion.so/1c4f3cb53138461586687a1306ab0fb5" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/1c4f3cb53138461586687a1306ab0fb5"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">原子性</span></span></h1><div id="https://www.notion.so/026c0cf1540f4f9eb917ba74598d01db" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">原子性是指一个事务是一个不可分割的工作单位，其中的操作要么都做，要么都不做；如果事务中一个sql语句执行失败，则已执行的语句也必须回滚，数据库退回到事务前的状态。</span></span></p></div><h2 id="https://www.notion.so/fb0137d4c64c495cbbf4cf292e3a369a" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/fb0137d4c64c495cbbf4cf292e3a369a"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">实现原理 undo log</span></span></h2><div id="https://www.notion.so/42bfb8f2822943f9bb89ca1b11eb4410" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">可以看到实现原子性的关键是，我们必须要保证sql执行失败的时候进行回滚。在innodb中，回滚的关键依靠的就是undo log。</span></span></p></div><div id="https://www.notion.so/b03136ae808b48babb3a0a3e33a090ec" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">每当我们对数据库进行修改的时候，就会记录相应操作到undo log中，如果事务需要回滚，那么就会根据undo log里面的记录把数据回滚到初始值。</span></span></p></div><div id="https://www.notion.so/2aa48f75c4a9493a95ce82b73836372a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">当发生回滚的时候，innodb会根据undo log里面的操作执行逆操作，例如：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/395e7fd2256e4234a02e7ece188b864c" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">记录了insert，就执行delete；记录了delete，就执行insert</span></span></li><li id="https://www.notion.so/a5a35824ef904fe594f64e5cb6f286cf" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">记录了update，则执行相反的update</span></span></li></ul><h1 id="https://www.notion.so/a2515967716349c7aebbd2c7ea3bf2be" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/a2515967716349c7aebbd2c7ea3bf2be"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">持久性</span></span></h1><div id="https://www.notion.so/e26dab689b4045708d24174b75b76e23" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">持久性是指事务一旦提交，它对数据库的改变就应该是永久性的。接下来的其他操作或故障不应该对其有任何影响。</span></span></p></div><h2 id="https://www.notion.so/b633ed2a3aae43138379a91811ee9d89" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/b633ed2a3aae43138379a91811ee9d89"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">实现原理 redo log</span></span></h2><div id="https://www.notion.so/8c2c2a46de464215ba0921c36e7c1792" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">持久性的实现关键在于及时的把操作记录下来，避免丢失。</span></span></p></div><div id="https://www.notion.so/fe6d807176e5483c96cd2bf27ad83601" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">innodb的实现机制是redo log。</span></span></p></div><div id="https://www.notion.so/9e7edd415eb5476f928d5f9fe9dfe030" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">InnoDB作为MySQL的存储引擎，数据是存放在磁盘中的，但如果每次读写数据都需要磁盘IO，效率会很低。为此，InnoDB提供了缓存(Buffer Pool)，Buffer Pool中包含了磁盘中部分数据页的映射，作为访问数据库的缓冲：当从数据库读取数据时，会首先从Buffer Pool中读取，如果Buffer Pool中没有，则从磁盘读取后放入Buffer Pool；当向数据库写入数据时，会首先写入Buffer Pool，Buffer Pool中修改的数据会定期刷新到磁盘中（这一过程称为刷脏）。</span></span></p></div><div id="https://www.notion.so/ce01e87aa9c94acb91302ba3c8af56d9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Buffer Pool的使用大大提高了读写数据的效率，但是也带了新的问题：如果MySQL宕机，而此时Buffer Pool中修改的数据还没有刷新到磁盘，就会导致数据的丢失，事务的持久性无法保证。</span></span></p></div><div id="https://www.notion.so/a3e8e970d4b748b2b9930825db1f2bde" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">于是，redo log被引入来解决这个问题：当数据修改时，除了修改Buffer Pool中的数据，还会在redo log记录这次操作；当事务提交时，会调用fsync接口对redo log进行刷盘。如果MySQL宕机，重启时可以读取redo log中的数据，对数据库进行恢复。</span></span></p></div><div id="https://www.notion.so/cb0a259040ec42928d57bf9b74be288d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">redo log采用的是WAL（Write-ahead logging，预写式日志），所有修改先写入日志，再更新到Buffer Pool，保证了数据不会因MySQL宕机而丢失，从而满足了持久性要求。</span></span></p></div><blockquote id="https://www.notion.so/3f0f0f0e561946c6b33eebd2dd80b1c3" class="ColorfulBlock ColorfulBlock--ColorDefault Quote"><span class="SemanticStringArray"><span class="SemanticString">二阶段提交：先写redo log，执行操作，操作成功后再写bin log</span></span></blockquote><h1 id="https://www.notion.so/5aa206ea9d404ff7afca9b319d1f990f" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/5aa206ea9d404ff7afca9b319d1f990f"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">隔离性</span></span></h1><div id="https://www.notion.so/ae4ebb13b2684b87946fa21af6140637" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">隔离性要求事务之间互相隔离，不会干扰对方操作。</span></span></p></div><h2 id="https://www.notion.so/55d6fe8d57dc4d30a91cba2f1665fccd" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/55d6fe8d57dc4d30a91cba2f1665fccd"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">隔离不足出现的问题</span></span></h2><ul class="BulletedListWrapper"><li id="https://www.notion.so/afc85cb481f54357a5d4657bd2338013" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">脏读</span></span></li></ul><div id="https://www.notion.so/52ab566a4fa4422c9e9a0580bdf5ea22" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">A事务读取到B事务未提交的数据，一旦B事务回滚，那么读取到的数据就是脏数据</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/39f28bfda9cf44f99836dba166cdfefa" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">不可重复读</span></span></li></ul><div id="https://www.notion.so/ae1921f54b6945aebb9c5fc42015ac88" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">A事务读取的数据被B事务修改，导致前后读取结果不一致</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/454f658b3b71413ba8d5dda97dff234e" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">幻读</span></span></li></ul><div id="https://www.notion.so/55a1f1e91b264074961c02f4e570ee3b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">A事务执行范围查询的期间，B事务在范围内写入了一些数据导致A事务再次执行范围查询的时候两次结果不一致</span></span></p></div><h2 id="https://www.notion.so/380eee2d9e9b4a4ea71b28f16e33a7fe" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/380eee2d9e9b4a4ea71b28f16e33a7fe"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">事务隔离级别</span></span></h2><div id="https://www.notion.so/161d9db0f64b49d2951a7b9cc160963e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">SQL定义了四种隔离级别，每种隔离级别均解决了一定的问题</span></span></p></div><div id="https://www.notion.so/6a0ff6b2c29540bdaffa49ed1c2f67b8" class="Image Image--Normal"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F2aa8a3e6-4e93-4eb5-be0c-87010cf10e7b%2FUntitled.png?width=549&amp;table=block&amp;id=6a0ff6b2-c295-40bd-affa-49ed1c2f67b8"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F2aa8a3e6-4e93-4eb5-be0c-87010cf10e7b%2FUntitled.png?width=549&amp;table=block&amp;id=6a0ff6b2-c295-40bd-affa-49ed1c2f67b8" style="width:549px"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/df57be1e9fa34305a59a2b8b7a041d95" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">innodb的默认隔离级别是RR，在SQL标准中RR无法解决幻读问题，但是innodb通过MVCC和加锁解决了幻读问题</span></span></p></div><h2 id="https://www.notion.so/cf997bf46ed041a5a460049f7e55cc06" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/cf997bf46ed041a5a460049f7e55cc06"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">RR隔离级别如何解决不可重复读和幻读</span></span></h2><div id="https://www.notion.so/b06a5b770e7b4c0d9393f4222d8535d4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">一句话总结：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/9609a6fa59dd4f898319ac46ed29e67f" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">当前读场景下使用加锁解决</span></span></li><li id="https://www.notion.so/4764724314ce4dcabb37b682af483460" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">快照读场景下使用MVCC解决</span></span></li></ul><div id="https://www.notion.so/6ca29600734a4e0a8fac2660f080103c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">当前读</strong></span></span></p></div><div id="https://www.notion.so/615f746b9ed24952ac6dd4795ea263b4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">定义：读取的数据是最新数据就是当前读</span></span></p></div><div id="https://www.notion.so/15acb992b7174096ade7c444e200f201" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">当前读的触发语句：</span></span></p></div><pre id="https://www.notion.so/50e71c52350f41ce83ada33ab2a3c537" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">select</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">lock</span> <span class="token operator">in</span> <span class="token keyword">share</span> <span class="token keyword">mode</span>  <span class="token comment"># 共享锁</span>

<span class="token keyword">select</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">for</span> <span class="token keyword">update</span> <span class="token comment"># 排他锁</span>

<span class="token keyword">update</span> <span class="token punctuation">,</span> <span class="token keyword">delete</span> <span class="token punctuation">,</span> <span class="token keyword">insert</span></span></span></span></code></pre><div id="https://www.notion.so/c9daff2082e34b2898a65162172602cf" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">如果我们执行</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">update , delete , insert</code></span><span class="SemanticString"> 这些写操作的语句，那么Mysql就会加行锁，保证涉及到的数据同一时刻只能被一个事务操作。</span></span></p></div><div id="https://www.notion.so/df979b5e42b941c698e9d898ddb9874d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">如果显式的加锁，执行select语句，那么mysql就会加上next-key lock来避免产生幻读问题</span></span></p></div><div id="https://www.notion.so/4ce950138e444c6daa1d28f7fa3b64e5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">next-key lock是行锁和间隙锁的结合体，首先使用行锁来锁住涉及到的数据，然后同时使用间隙锁锁住数据之间的间隙，不让其他事务进行插入。</span></span></p></div><div id="https://www.notion.so/2b55aca7802d4a5ca42e1c354e535d3a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">快照读</strong></span></span></p></div><div id="https://www.notion.so/4e4dfffa7b634c53af900e479a4eb721" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">快照读指的是读取到的数据是某一时刻的快照</span></span></p></div><div id="https://www.notion.so/bdf962377b5b4a028a76cfa2d49da6b2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">快照读的触发语句：</span></span></p></div><pre id="https://www.notion.so/ba1d69612185488d855ebca727c7b2ea" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>简单的<span class="token keyword">select</span>操作<span class="token punctuation">(</span>不包括 <span class="token keyword">select</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">lock</span> <span class="token operator">in</span> <span class="token keyword">share</span> <span class="token keyword">mode</span><span class="token punctuation">,</span> <span class="token keyword">select</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">for</span> <span class="token keyword">update</span><span class="token punctuation">)</span>。</span></span></span></code></pre><div id="https://www.notion.so/5068bbb5a00d4dc1ab512f2c0968ebed" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">快照读解决不可重复读和幻读问题的是MVCC。</span></span></p></div><div id="https://www.notion.so/388bd698cbe046a1983b1529885e3633" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">MVCC</strong></span></span></p></div><div id="https://www.notion.so/ab6b82611679426abc70fe982742779f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">多版本并发控制。</span></span></p></div><div id="https://www.notion.so/8ee5a4bce1ca42c99cb76981326ae56e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">MVCC依赖于几个关键组件</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/a67bd7fc27f54a93af7616d7654243d5" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">隐藏列</span></span></li></ul><div id="https://www.notion.so/c2fecfdb09b74c44a74286da3ab16dea" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">innodb中的隐藏列有：</span></span></p><div class="Text__Children"><ul class="BulletedListWrapper"><li id="https://www.notion.so/c2ff2941f89542c59e94c4d3ae3486f5" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">本行数据的事务id，指向undo log的指针，自增id</span></span></li></ul></div></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/fd58f2bd6d8d4d7aa054da4050509123" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">基于undo log的版本链</span></span></li></ul><div id="https://www.notion.so/5828e92e5213434c85cb235708d01e7a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">每个指针会指向更早版本的undo log，从而形成一条版本脸</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/8214d04b18d8409b96b929015259ae9a" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">ReadView</span></span></li></ul><div id="https://www.notion.so/6ae53ea4685748a8be1e7fa2f72b7e9f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">通过版本链和隐藏列，Mysql可以将数据恢复到指定版本。</span></span></p></div><div id="https://www.notion.so/acd366b15d0d4dd4b7f300cc6a263eb9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">所谓的ReadView就是事务某一时刻给整个事务系统（trx_sys）打快照，之后在进行读操作的时候，根据事务id和快照相比，从而判断数据是否对当前事务可见。</span></span></p></div><div id="https://www.notion.so/22f64058de6742a5859b0dd53d73408a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">trx_sys中又包含了几个字段</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/2a4d1f07c0424264bd7b99589ebdc1f5" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">low_limit_id：表示生成ReadView时系统中应该分配给下一个事务的id。如果数据的事务id大于等于low_limit_id，则对该ReadView不可见。</span></span></li><li id="https://www.notion.so/77536a3dd7ee4226bef3248c7d88b8a1" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">up_limit_id：表示生成ReadView时当前系统中活跃的读写事务中最小的事务id。如果数据的事务id小于up_limit_id，则对该ReadView可见。</span></span></li><li id="https://www.notion.so/07f0656b0a2e4320be0b65cdb8d3d5a4" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">rw_trx_ids：表示生成ReadView时当前系统中活跃的读写事务的事务id列表。如果数据的事务id在low_limit_id和up_limit_id之间，则需要判断事务id是否在rw_trx_ids中：如果在，说明生成ReadView时事务仍在活跃中，因此数据对ReadView不可见；如果不在，说明生成ReadView时事务已经提交了，因此数据对ReadView可见。</span></span></li></ul><div id="https://www.notion.so/4fe5be991935416487a79dc208d2e8f7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">总结：</span></span></p></div><div id="https://www.notion.so/d082ccc069c7447ebb373b21ed369b99" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">依靠快照和事务id，MVCC决定哪些数据可见哪些数据不可见，从而解决了不可重复读和幻读问题。MVCC和核心是undo log的版本链，通过版本链可以恢复数据。</span></span></p></div><h1 id="https://www.notion.so/3394c2b821ce45c683a23613d97bd655" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/3394c2b821ce45c683a23613d97bd655"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">一致性</span></span></h1><div id="https://www.notion.so/d0cfb2b3cbfd441ea915db73f8370e5d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">一致性是指事务执行结束后，</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">数据库的完整性约束没有被破坏，事务执行的前后都是合法的数据状态。</strong></span><span class="SemanticString">数据库的完整性约束包括但不限于：实体完整性（如行的主键存在且唯一）、列完整性（如字段的类型、大小、长度要符合要求）、用户自定义完整性（如转账前后，两个账户余额的和应该不变）。</span></span></p></div><div id="https://www.notion.so/5d01dc34170d4e93a93b02f4189c5eea" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">常见的例子就是，A用户给B用户转账1万元，转账前后两个账户钱的和是一致的，不会产生变化。相当于从一个合法的状态转换到了另一个合法的状态。</span></span></p></div><h2 id="https://www.notion.so/89ec1be975154ce282d3283ac4e065ff" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/89ec1be975154ce282d3283ac4e065ff"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">如何实现一致性</span></span></h2><div id="https://www.notion.so/1c5cf21821cf4355988117fcb61eda0f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">一致性是事务追求的最终目标，它的实现基于原子性、隔离性、持久性的实现基础。在此基础上，要求数据库提供保障，例如不允许向整形列插入字符串值等。</span></span></p></div><h1 id="https://www.notion.so/8cf1696ecf2e40a98647acefd7a6c356" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/8cf1696ecf2e40a98647acefd7a6c356"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">总结</span></span></h1><ul class="BulletedListWrapper"><li id="https://www.notion.so/bdae11a4c85a43dab7228f89528ae84a" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">原子性</span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/86e1f28346cf4d96a67ab4e1955333a1" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">要么全部执行，要么全部不执行</span></span></li><li id="https://www.notion.so/3b2ea6f5cab845808d6e51747f48d45d" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">undo log，回滚数据</span></span></li></ul></li><li id="https://www.notion.so/b76f5890a09d4e3d80c48a3cea8a86b9" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">持久性</span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/acbb65f9e6ba450b9c184755e7cfabe2" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">事物的操作是永久的</span></span></li><li id="https://www.notion.so/05c6a7f0f72b452394b3ab877851a370" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">redo log，预写操作，保证操作不丢失及时落盘</span></span></li></ul></li><li id="https://www.notion.so/f4b3398d4ada419ab0499c698f6d993c" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">隔离性</span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/277f7865f1314bdfb4c5567c621f8202" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">事务之间互相隔离，不影响对方执行</span></span></li><li id="https://www.notion.so/e895859a2e2b41858151dfb74723f464" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">当前读使用锁机制，快照读使用MVCC</span></span></li></ul></li><li id="https://www.notion.so/cef0409b73cb4ae0b084d6491054f675" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">一致性</span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/53e5c4ee7cf54077bdf1d8fd46453e5c" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">事务执行前后，数据的状态是合法的，数据库的完整性约束没有被破坏</span></span></li><li id="https://www.notion.so/47c4ad2a00464083a7125882abb9a327" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">要求我们实现好原子性、持久性、隔离性</span></span></li></ul></li></ul><div id="https://www.notion.so/e55d9eba6e614a65abc7dd7f99c5bd39" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h1 id="https://www.notion.so/27d4f2c0f11e4e9eb3a150b93362899f" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/27d4f2c0f11e4e9eb3a150b93362899f"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Ref</span></span></h1><div id="https://www.notion.so/836898d4a78e497084633368a5cacc78" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://www.cnblogs.com/kismetv/p/10331633.html">深入学习MySQL事务：ACID特性的实现原理 - 编程迷思 - 博客园 (cnblogs.com)</a></span></span></p></div></article>
  <footer class="Footer">
  <div>&copy; Notablog 2022</div>
  <div>&centerdot;</div>
  <div>Powered by <a href="https://github.com/dragonman225/notablog" target="_blank"
      rel="noopener noreferrer">Notablog</a>.
  </div>
</footer>
</body>

</html>